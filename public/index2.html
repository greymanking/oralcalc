<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>口算训练</title>
  <style>
    body {
      background-color: beige;
    }

    li {
      cursor: pointer;
      font-size: 2em;
    }

    li.selected {
      color: blue;
    }

    li.unselected {
      color: black;
    }

    button {
      font-size: 2em;
      margin: 10px;
      padding: 0 20px;
    }

    #extraInfoPane {
      font-size: 1.5em;
    }

    #ansPane {
      font-size: 1.5em;
    }

    #title {
      font-size: 2em;
    }

    #perf {
      font-size: 1.5em;
      margin: 15px 0;
      color: blue;
      text-align: left;
    }

    #taskPane {
      margin: 0 auto;
      text-align: center;
      vertical-align: middle;
      max-width: 30em;
    }

    #questionPane {
      font-size: 10em;
      vertical-align: bottom;
    }

    #resPane {
      font-size: 6em;
    }

    #ansPane {
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div id="taskPane">
    <ul id="listPane" class="pane">
    </ul>
    <div id="perfPane" class="pane">
      <div id="title"></div>
      <div id="perf"></div>
    </div>
    <div id="extraInfoPane" class="pane"></div>
    <div id="questionPane" class="pane"></div>
    <div id="resPane" class="pane"></div>
    <div id="btnPane">
      <button id="nextBtn">下一题</button>
      <button id="startBtn">出　发</button>
      <button id="repeatBtn">再一次</button>
      <button id="perfBtn">看成绩</button>
      <button id="backBtn">返　回</button>
    </div>
    <div id="ansPane" class="pane">
    </div>
  </div>
</body>
<script type="text/javascript" src="./jquery-3.4.1.min.js"></script>
<script type="text/javascript" src="./utils.js"></script>
<script type="text/javascript">
  document.body.style.fontSize = Math.min(16, Math.floor(window.innerWidth / 30)) + "px";

  var ui = {
    showBtnsOnly: function () {
      let sb = new Set(arguments);
      $("button").each(function () {
        $(this).css("display", sb.has($(this).attr("id")) ? "inline" : "none");
      });
    },
    showPanesOnly: function () {
      let sb = new Set(arguments);
      $(".pane").each(function () {
        $(this).css("display", sb.has($(this).attr("id")) ? "block" : "none");
      });
    },
    showActiveTitle: function (ckey) {
      $("#listPane>li").each(function () {
        if ($(this).attr("key") == ckey) {
          $(this).removeClass("unselected").addClass("selected");
        } else {
          $(this).removeClass("selected").addClass("unselected");
        }
      });
    }
  }

  var tasks = {
    data: {}, //{key:{title:string,recs:[{date:string,secs:int}]}}
    fetchList: function () {
      $.ajax({
        url: "/dataindex.json",
        dataType: "json" //默认是Intelligent Guess，如果再做parse会出错
      }).done(function (tasks) {
        for (let i = 0; i < tasks.length; i++) {
          let task = tasks[i];
          $('<li>', { key: task.key }).text(task.title).appendTo($("#listPane"));
          //tasks[task.key] = { title: task.title }
          if (i == 0) {
            globals.setActiveTask(task.key);
          }
        }
        $("#listPane>li").click(function () { globals.setActiveTask($(this).attr("key")); });
        globals.setStage(READY);
      });
    },
    fetchRecs: function (key) { },
    addRec: function (key, date, secs) {
      let recs = this.data[key].recs;
      if (!recs) {
        recs = [];
        this.data[key].recs = recs;
      }
      let newRec = { date: formatDate(date), secs: secs };
      recs.push(newRec);
    },
  }

  var activeTask = {
    // key: "",
    // data: null,
    // pos: 0,
    // startTime: 0,
    showWork: function () {
      $("#extraInfoPane").text(`第${this.pos + 1}题`);
      $("#questionPane").text(this.data[this.pos]);
      $("#ansPane").text("点击看答案");
    },
    moveNext: function () {
      this.pos++;
      if (this.pos == this.data.length) {
        globals.setStage(FINISHED);
      } else {
        this.showWork();
      }
    }
  }

  var PERFINFO = -2, READY = -1, WORKING = 0, FINISHED = 1;

  var globals = {
    stage: READY,
    setActiveTask: function (key) {
      activeTask.key = key;
      ui.showActiveTitle(key);
    },
    startWork: function () {
      $.ajax({
        url: "/data/" + activeTask.key + ".json",
        dataType: "json"
      }).done(function (data) {
        activeTask.data = data;
        activeTask.startTime = new Date().getTime();
        activeTask.pos = 0;

        globals.setStage(WORKING);
      });
    },
    setStage: function (stage) {
      this.stage = stage;
      if (stage == READY) {
        ui.showBtnsOnly("startBtn", "perfBtn");
        ui.showPanesOnly("listPane");
      } else if (stage == PERFINFO) {
        ui.showBtnsOnly("backBtn");
        ui.showPanesOnly("perfPane");
      } else if (stage == WORKING) {
        ui.showBtnsOnly("nextBtn");
        ui.showPanesOnly("extraInfoPane", "ansPane", "questionPane");
        activeTask.showWork();
      } else if (stage == FINISHED) {
        ui.showBtnsOnly("repeatBtn");
        ui.showPanesOnly("resPane");

        let curDate = new Date();
        let secs = Math.round((curDate.getTime() - tasks.active.startTime) / 1000);
        $("#resPane").text(secsToMinSecs(secs));
        tasks.addRec(activeTask.key, curDate, secs);
      }
    }
  }

  //***以下定义及创建元素变量***//

  var lPane = document.getElementById("listPane");
  var pPane = document.getElementById("perfPane");

  var qPane = document.getElementById("questionPane");
  var aPane = document.getElementById("ansPane");

  var ei = document.getElementById("extraInfoPane");

  var rPane = document.getElementById("resPane");

  var startBtn = document.getElementById("startBtn");
  var nextBtn = document.getElementById("nextBtn");
  var perfBtn = document.getElementById("perfBtn");
  var backBtn = document.getElementById("backBtn");
  var repeatBtn = document.getElementById("repeatBtn");

  var titleEl = document.getElementById("title");
  var perfEl = document.getElementById("perf");

//todo
  function viewPerf() {
    let title = curTitle;
    titleEl.innerHTML = title;

    let recStr = localStorage.getItem(title);
    if (recStr) {
      rec = JSON.parse(recStr);
      perfEl.innerHTML = "";
      for (let k in rec) {
        perfEl.innerHTML += (k + "&nbsp;&nbsp;&nbsp;" + secsToMinSecs(parseInt(rec[k])) + "<BR />");
      }
    } else {
      perfEl.innerHTML = "无记录";
    }

    globals.setStage(PERFINFO);
  }

//todo
  function addRec(title, secs) {
    let recs = {};
    let recsStr = localStorage.getItem(title);
    if (recsStr) {
      recs = JSON.parse(recsStr);
    }

    recs[formatDate("YYYY-mm-dd HH:MM:SS", new Date())] = secs;

    localStorage.setItem(title, JSON.stringify(recs));
  }

  $(function () {
    //如果写在keyup上，会触发body中元素的默认keypress行为
    $("body").keypress(function (ev) {
      if (ev.which == 13) {
        ev.preventDefault();
        ev.stopPropagation();
        globals.stage == READY ? globals.startWork() : activeTask.moveNext();
      }
    });

    $("#startBtn").click(function () { globals.startWork(); });
    perfBtn.onclick = viewPerf;
    $("#nextBtn").click(function () { activeTask.moveNext(); });
    $("#backBtn").click(function () { globals.setStage(READY); });
    $("#repeatBtn").click(function () { globals.setStage(READY); });
    $("#ansPane").click(function () { $(this).text("答案：" + eval(activeTask.data[activeTask.pos])); });

    tasks.fetchList();
  });
</script>

</html>